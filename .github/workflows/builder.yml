name: ESP32 Firmware Builder

on:
  push:
    branches: [ main, develop, master ]
    paths:
      - '**.cpp'
      - '**.ino'
      - '.github/workflows/builder.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SKETCH_NAME: esp32_security_demo
  ESP32_FQBN: esp32:esp32:esp32
  ESP32_PLATFORM: esp32:esp32
  ARDUINO_CLI_VERSION: 0.35.3

jobs:
  build:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: üì¶ Cache Arduino packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.arduino15/packages
          ~/.arduino15/staging
        key: ${{ runner.os }}-arduino-${{ env.ESP32_PLATFORM }}-${{ hashFiles('**/main.cpp') }}
        restore-keys: |
          ${{ runner.os }}-arduino-${{ env.ESP32_PLATFORM }}-
          ${{ runner.os }}-arduino-
    
    - name: üîß Install Arduino CLI
      run: |
        cd ~
        wget -q https://github.com/arduino/arduino-cli/releases/download/v${ARDUINO_CLI_VERSION}/arduino-cli_${ARDUINO_CLI_VERSION}_Linux_64bit.tar.gz
        tar -xzf arduino-cli_${ARDUINO_CLI_VERSION}_Linux_64bit.tar.gz
        sudo mv arduino-cli /usr/local/bin/
        arduino-cli version
    
    - name: ‚öôÔ∏è Configure Arduino CLI
      run: |
        arduino-cli config init --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli config set library.enable_unsafe_install true
        arduino-cli core update-index
    
    - name: üìö Install ESP32 platform
      run: |
        arduino-cli core install ${{ env.ESP32_PLATFORM }} --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core list
    
    - name: üìù Prepare sketch structure
      run: |
        mkdir -p ${{ env.SKETCH_NAME }}
        if [ -f "main.cpp" ]; then
          cp main.cpp ${{ env.SKETCH_NAME }}/${{ env.SKETCH_NAME }}.ino
        elif [ -f "src/main.cpp" ]; then
          cp src/main.cpp ${{ env.SKETCH_NAME }}/${{ env.SKETCH_NAME }}.ino
        else
          echo "‚ùå Error: main.cpp not found"
          exit 1
        fi
        echo "‚úÖ Sketch structure created"
        ls -la ${{ env.SKETCH_NAME }}/
    
    - name: üîç Verify compilation
      run: |
        echo "üî® Starting compilation verification..."
        arduino-cli compile --fqbn ${{ env.ESP32_FQBN }} ${{ env.SKETCH_NAME }}/ --verbose
    
    - name: üèóÔ∏è Build firmware binary
      run: |
        echo "üî® Building firmware binary..."
        mkdir -p build
        arduino-cli compile --fqbn ${{ env.ESP32_FQBN }} ${{ env.SKETCH_NAME }}/ --output-dir build/ --export-binaries
        echo "‚úÖ Build completed"
    
    - name: üìä Generate build report
      run: |
        echo "üìä Build Report"
        echo "==============="
        ls -lh build/
        
        if [ -f "build/${{ env.SKETCH_NAME }}.ino.bin" ]; then
          BINARY_SIZE=$(stat -c%s "build/${{ env.SKETCH_NAME }}.ino.bin")
          BINARY_SIZE_KB=$(echo "scale=2; $BINARY_SIZE/1024" | bc)
          echo ""
          echo "‚úÖ Firmware binary created successfully"
          echo "üì¶ Binary size: ${BINARY_SIZE_KB} KB (${BINARY_SIZE} bytes)"
          
          # Check if binary size is reasonable (not too small or too large)
          if [ $BINARY_SIZE -lt 10000 ]; then
            echo "‚ö†Ô∏è Warning: Binary size seems unusually small"
          elif [ $BINARY_SIZE -gt 1500000 ]; then
            echo "‚ö†Ô∏è Warning: Binary size is very large"
          fi
        else
          echo "‚ùå Error: Binary file not found"
          exit 1
        fi
        
        # Display memory usage if available
        if [ -f "build/${{ env.SKETCH_NAME }}.ino.elf" ]; then
          echo ""
          echo "üíæ Memory Usage:"
          size build/${{ env.SKETCH_NAME }}.ino.elf || true
        fi
    
    - name: üì§ Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esp32-firmware-${{ github.sha }}
        path: |
          build/*.bin
          build/*.elf
          build/*.map
        retention-days: 30
        if-no-files-found: error
    
    - name: üìã Create build summary
      if: always()
      run: |
        echo "# üîí ESP32 Security Research Firmware Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/${{ env.SKETCH_NAME }}.ino.bin" ]; then
          echo "## ‚úÖ Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          BINARY_SIZE=$(stat -c%s "build/${{ env.SKETCH_NAME }}.ino.bin")
          BINARY_SIZE_KB=$(echo "scale=2; $BINARY_SIZE/1024" | bc)
          
          echo "### üìä Build Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Board** | ESP32 Dev Module |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | ${{ env.ESP32_PLATFORM }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Firmware Size** | ${BINARY_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Firmware binary (.bin)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ELF file (.elf)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Memory map (.map)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üöÄ Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts and flash using:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 ${{ env.SKETCH_NAME }}.ino.bin" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ùå Build Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è Compilation failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Educational Hardware Security Research Demo*" >> $GITHUB_STEP_SUMMARY
    
    - name: üß™ Run post-build checks
      if: success()
      run: |
        echo "üß™ Running post-build verification..."
        
        # Check if binary exists and has reasonable size
        if [ ! -f "build/${{ env.SKETCH_NAME }}.ino.bin" ]; then
          echo "‚ùå Binary file missing"
          exit 1
        fi
        
        BINARY_SIZE=$(stat -c%s "build/${{ env.SKETCH_NAME }}.ino.bin")
        
        if [ $BINARY_SIZE -lt 5000 ]; then
          echo "‚ùå Binary size too small: ${BINARY_SIZE} bytes"
          exit 1
        fi
        
        if [ $BINARY_SIZE -gt 2000000 ]; then
          echo "‚ö†Ô∏è Warning: Binary size very large: ${BINARY_SIZE} bytes"
        fi
        
        echo "‚úÖ All post-build checks passed"
    
    - name: üí¨ Comment on PR
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const binaryPath = 'build/${{ env.SKETCH_NAME }}.ino.bin';
          
          if (fs.existsSync(binaryPath)) {
            const stats = fs.statSync(binaryPath);
            const sizeKB = (stats.size / 1024).toFixed(2);
            
            const comment = `## ‚úÖ ESP32 Firmware Build Successful
            
            **Firmware Size:** ${sizeKB} KB
            **Commit:** \`${context.sha.substring(0, 7)}\`
            
            üì¶ Download the firmware from the workflow artifacts.
            
            ### Flash Instructions:
            \`\`\`bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 firmware.bin
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
 
  # Optional: Create release on tag push
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: üì¶ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: esp32-firmware-${{ github.sha }}
        path: firmware
    
    - name: üè∑Ô∏è Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware/*.bin
          firmware/*.elf
        body: |
          ## ESP32 Security Research Firmware
          
          **Version:** ${{ github.ref_name }}
          
          ### üì¶ Files Included:
          - `*.bin` - Flash this to your ESP32
          - `*.elf` - Debug symbols (optional)
          
          ### üöÄ Flash Instructions:
          ```bash
          esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 firmware.bin
          ```
          
          ### ‚ö†Ô∏è Educational Use Only
          This firmware is for hardware security research in controlled lab environments on devices you own.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
