name: ESP32 Firmware Builder

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Cache Arduino CLI
      uses: actions/cache@v3
      with:
        path: |
          ~/.arduino15
          ~/Arduino/libraries
        key: ${{ runner.os }}-arduino-${{ hashFiles('**/main.cpp') }}
        restore-keys: |
          ${{ runner.os }}-arduino-
    
    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$HOME/bin" >> $GITHUB_PATH
    
    - name: Initialize Arduino CLI config
      run: |
        arduino-cli config init
        arduino-cli config set library.enable_unsafe_install true
    
    - name: Add ESP32 board support
      run: |
        arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
    
    - name: Create Arduino sketch structure
      run: |
        mkdir -p esp32_security_demo
        cp main.cpp esp32_security_demo/esp32_security_demo.ino
    
    - name: Verify compilation for ESP32
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 esp32_security_demo/ --verbose
    
    - name: Build firmware binary
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 esp32_security_demo/ --output-dir build/
    
    - name: Display build info
      run: |
        echo "Build completed successfully!"
        ls -lh build/
        if [ -f build/esp32_security_demo.ino.bin ]; then
          echo "Firmware size:"
          stat -c%s build/esp32_security_demo.ino.bin | awk '{print $1/1024 " KB"}'
        fi
    
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: esp32-firmware
        path: |
          build/*.bin
          build/*.elf
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Compilation successful**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Board:** ESP32" >> $GITHUB_STEP_SUMMARY
        echo "**Compiler:** Arduino CLI with ESP32 core" >> $GITHUB_STEP_SUMMARY
        if [ -f build/esp32_security_demo.ino.bin ]; then
          SIZE=$(stat -c%s build/esp32_security_demo.ino.bin)
          echo "**Firmware size:** $(echo $SIZE | awk '{print $1/1024}') KB" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts:** Firmware binary available for download" >> $GITHUB_STEP_SUMMARY
